class c{constructor(){this.apiEndpoint="/api/admin/ai/generate-product-description",this.init()}init(){const e=document.getElementById("generate-short-description-btn"),n=document.getElementById("generate-long-description-btn");e&&e.addEventListener("click",()=>this.generateDescription("short")),n&&n.addEventListener("click",()=>this.generateDescription("long"))}collectProductData(){const e=document.getElementById("category_id"),n=e?.value||"",t=e?this.getSelectedText("category_id"):"",s=document.getElementById("is_original"),i=s?s.checked:!1,o={name:document.getElementById("name")?.value||"",author:document.getElementById("author")?.value||"",publisher:document.getElementById("publisher")?.value||"",is_original:i,product_type:i?"original":"normal",category_id:n||null,category_name:t,tags:this.getSelectedTags(),sku:document.getElementById("sku")?.value||"",retail_price:document.getElementById("retail_price")?.value||""};return Object.keys(o).forEach(r=>{(o[r]===""||o[r]===null)&&delete o[r]}),o}getSelectedText(e){const n=document.getElementById(e);if(!n||!n.value)return"";const t=n.options[n.selectedIndex];return t?t.text.trim():""}getSelectedTags(){const e=document.getElementById("tags");if(!e)return[];if(window.Choices){const t=e._choicesjs||e.closest(".choices")?._choicesjs||Choices.getInstance(e);if(t){const s=t.getValue(!0);if(Array.isArray(s))return(t.store.activeItems||[]).map(o=>o.label||o.value).filter(Boolean)}}return Array.from(e.selectedOptions).map(t=>t.text?.trim()||t.value).filter(Boolean)}async generateDescription(e){const n=this.collectProductData();if(!n.name||n.name.trim()===""){this.showError("يرجى إدخال اسم المنتج أولاً");return}const t=e==="short"?"generate-short-description-btn":"generate-long-description-btn",s=document.getElementById(t),i=e==="short"?"short_description":"long_description";if(!s){console.error(`Button with id ${t} not found`);return}this.setLoadingState(s,!0);try{const o=await this.callAIAPI({...n,type:e});if(o.success){const r=document.getElementById(i);if(r){const a=e==="short"?o.short_description:o.long_description;r.value=a||"",this.showSuccess("تم توليد الوصف بنجاح")}else this.showError("حقل الوصف غير موجود")}else this.showError(o.message||"فشل في توليد الوصف")}catch(o){console.error("Error generating description:",o),this.showError("حدث خطأ أثناء توليد الوصف. يرجى المحاولة مرة أخرى.")}finally{this.setLoadingState(s,!1)}}async callAIAPI(e){const n=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",t=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":n},credentials:"same-origin",body:JSON.stringify(e)});if(!t.ok){const s=await t.json().catch(()=>({message:"خطأ في التواصل مع الخادم"}));throw new Error(s.message||`HTTP error! status: ${t.status}`)}return await t.json()}setLoadingState(e,n){if(n)e.disabled=!0,e.innerHTML=`
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                جاري التوليد...
            `;else{e.disabled=!1;const t=e.getAttribute("data-original-text")||"توليد نص تلقائي";e.innerHTML=`
                <iconify-icon icon="solar:magic-stick-3-bold-duotone" class="fs-18 me-2"></iconify-icon>
                ${t}
            `}}showSuccess(e){window.Toastify?Toastify({text:e,duration:3e3,gravity:"top",position:"left",style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast():alert(e)}showError(e){window.Toastify?Toastify({text:e,duration:4e3,gravity:"top",position:"left",style:{background:"linear-gradient(to right, #ff5f6d, #ffc371)"}}).showToast():alert(e)}}document.addEventListener("DOMContentLoaded",()=>{(document.getElementById("generate-short-description-btn")||document.getElementById("generate-long-description-btn"))&&new c});
