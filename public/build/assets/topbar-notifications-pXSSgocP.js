class c{constructor(){this.badgeElement=document.getElementById("notifications-badge-count"),this.listElement=document.getElementById("notifications-list"),this.dropdownElement=document.getElementById("page-header-notifications-dropdown"),this.markAllReadBtn=document.getElementById("mark-all-read-btn"),this.loaded=!1,this.pollingInterval=null,this.lastCount=0,this.init()}init(){this.updateBadgeCount().then(()=>{this.badgeElement&&(this.lastCount=parseInt(this.badgeElement.textContent)||0)}),this.dropdownElement&&this.dropdownElement.addEventListener("shown.bs.dropdown",()=>{this.loaded||this.loadNotifications()}),this.markAllReadBtn&&this.markAllReadBtn.addEventListener("click",t=>{t.preventDefault(),this.markAllAsRead()}),this.startPolling()}async updateBadgeCount(){try{const t=await fetch("/api/admin/notifications/unread-count",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok){const e=await t.json();if(this.badgeElement){const n=e.count||0,i=this.lastCount;this.lastCount=n,this.badgeElement.textContent=n,n===0?this.badgeElement.style.display="none":(this.badgeElement.style.display="inline-block",n>i&&i>0&&this.playNotificationSound())}}}catch(t){console.error("Error updating badge count:",t)}}playNotificationSound(){try{const t=new Audio("/sounds/notification.mp3");t.volume=.5,t.play().catch(e=>{console.log("[TopbarNotifications] Audio file not found, using Web Audio API fallback:",e),this.playWebAudioNotification()})}catch(t){console.log("[TopbarNotifications] Using Web Audio API fallback:",t),this.playWebAudioNotification()}}playWebAudioNotification(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.setValueAtTime(800,t.currentTime),e.type="sine",n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1),e.start(t.currentTime),e.stop(t.currentTime+.1),setTimeout(()=>{const i=t.createOscillator(),o=t.createGain();i.connect(o),o.connect(t.destination),i.frequency.setValueAtTime(600,t.currentTime),i.type="sine",o.gain.setValueAtTime(.3,t.currentTime),o.gain.exponentialRampToValueAtTime(.01,t.currentTime+.15),i.start(t.currentTime),i.stop(t.currentTime+.15)},100)}catch(t){console.warn("[TopbarNotifications] Could not play notification sound:",t)}}async loadNotifications(){if(this.listElement){this.listElement.innerHTML='<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';try{const t=await fetch("/notifications?filter=unread&per_page=5",{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok){const e=await t.json();this.renderNotifications(e.data||[]),this.loaded=!0}else this.listElement.innerHTML='<div class="text-center py-4 text-muted">لا توجد إشعارات</div>'}catch(t){console.error("Error loading notifications:",t),this.listElement.innerHTML='<div class="text-center py-4 text-danger">حدث خطأ في تحميل الإشعارات</div>'}}}renderNotifications(t){if(!t||t.length===0){this.listElement.innerHTML='<div class="text-center py-4 text-muted">لا توجد إشعارات غير مقروءة</div>';return}let e="";t.forEach(n=>{const i=!n.read_at,o=this.getTimeAgo(n.created_at),a=n.type==="low_stock"?"solar:box-bold-duotone":"solar:bell-bing-bold-duotone",s=i?"bg-light":"";e+=`
                <a href="${n.data?.url||`/notifications/${n.id}`}"
                   class="dropdown-item py-3 border-bottom ${s}"
                   onclick="topbarNotifications.markAsRead(${n.id}, event)">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <iconify-icon icon="${a}" class="fs-20 text-primary"></iconify-icon>
                        </div>
                        <div class="flex-grow-1 ms-2">
                            <p class="mb-0 fw-semibold">${this.escapeHtml(n.title)}</p>
                            <p class="mb-0 text-muted small">${this.escapeHtml(n.body)}</p>
                            <small class="text-muted">${o}</small>
                        </div>
                    </div>
                </a>
            `}),this.listElement.innerHTML=e}async markAsRead(t,e){e&&e.preventDefault();try{(await fetch(`/notifications/${t}/read`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},credentials:"same-origin"})).ok&&(this.updateBadgeCount(),this.loaded=!1,this.loadNotifications())}catch(n){console.error("Error marking notification as read:",n)}}async markAllAsRead(){try{(await fetch("/notifications/read-all",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},credentials:"same-origin"})).ok&&(this.updateBadgeCount(),this.loaded=!1,this.loadNotifications())}catch(t){console.error("Error marking all as read:",t)}}startPolling(){this.pollingInterval=setInterval(()=>{this.updateBadgeCount()},3e4)}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}getTimeAgo(t){const e=new Date(t),i=new Date-e,o=Math.floor(i/1e3),a=Math.floor(o/60),s=Math.floor(a/60),r=Math.floor(s/24);return r>0?`منذ ${r} يوم`:s>0?`منذ ${s} ساعة`:a>0?`منذ ${a} دقيقة`:"الآن"}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}let l;document.addEventListener("DOMContentLoaded",()=>{l=new c,window.topbarNotifications=l});
