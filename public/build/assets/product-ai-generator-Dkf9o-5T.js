class a{constructor(){this.apiEndpoint="/api/admin/ai/generate-product-description",this.init()}init(){const e=document.getElementById("generate-short-description-btn"),n=document.getElementById("generate-long-description-btn");e&&e.addEventListener("click",()=>this.generateDescription("short")),n&&n.addEventListener("click",()=>this.generateDescription("long"))}collectProductData(){const e=document.getElementById("category_id"),n=e?.value||"",t=e?this.getSelectedText("category_id"):"",o={name:document.getElementById("name")?.value||"",author:document.getElementById("author")?.value||"",publisher:document.getElementById("publisher")?.value||"",product_type:document.getElementById("product_type")?.value||"",category_id:n||null,category_name:t,tags:this.getSelectedTags(),color:document.getElementById("color")?.value||"",sku:document.getElementById("sku")?.value||"",retail_price:document.getElementById("retail_price")?.value||""};return Object.keys(o).forEach(r=>{(o[r]===""||o[r]===null)&&delete o[r]}),o}getSelectedText(e){const n=document.getElementById(e);if(!n||!n.value)return"";const t=n.options[n.selectedIndex];return t?t.text.trim():""}getSelectedTags(){const e=document.getElementById("tags");if(!e)return[];if(window.Choices){const t=e._choicesjs||e.closest(".choices")?._choicesjs||Choices.getInstance(e);if(t){const o=t.getValue(!0);if(Array.isArray(o))return(t.store.activeItems||[]).map(s=>s.label||s.value).filter(Boolean)}}return Array.from(e.selectedOptions).map(t=>t.text?.trim()||t.value).filter(Boolean)}async generateDescription(e){const n=this.collectProductData();if(!n.name||n.name.trim()===""){this.showError("يرجى إدخال اسم المنتج أولاً");return}const t=e==="short"?"generate-short-description-btn":"generate-long-description-btn",o=document.getElementById(t),r=e==="short"?"short_description":"long_description";if(!o){console.error(`Button with id ${t} not found`);return}this.setLoadingState(o,!0);try{const s=await this.callAIAPI({...n,type:e});if(s.success){const i=document.getElementById(r);if(i){const c=e==="short"?s.short_description:s.long_description;i.value=c||"",this.showSuccess("تم توليد الوصف بنجاح")}else this.showError("حقل الوصف غير موجود")}else this.showError(s.message||"فشل في توليد الوصف")}catch(s){console.error("Error generating description:",s),this.showError("حدث خطأ أثناء توليد الوصف. يرجى المحاولة مرة أخرى.")}finally{this.setLoadingState(o,!1)}}async callAIAPI(e){const n=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",t=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":n},credentials:"same-origin",body:JSON.stringify(e)});if(!t.ok){const o=await t.json().catch(()=>({message:"خطأ في التواصل مع الخادم"}));throw new Error(o.message||`HTTP error! status: ${t.status}`)}return await t.json()}setLoadingState(e,n){if(n)e.disabled=!0,e.innerHTML=`
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                جاري التوليد...
            `;else{e.disabled=!1;const t=e.getAttribute("data-original-text")||"توليد نص تلقائي";e.innerHTML=`
                <iconify-icon icon="solar:magic-stick-3-bold-duotone" class="fs-18 me-2"></iconify-icon>
                ${t}
            `}}showSuccess(e){window.Toastify?Toastify({text:e,duration:3e3,gravity:"top",position:"left",style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast():alert(e)}showError(e){window.Toastify?Toastify({text:e,duration:4e3,gravity:"top",position:"left",style:{background:"linear-gradient(to right, #ff5f6d, #ffc371)"}}).showToast():alert(e)}}document.addEventListener("DOMContentLoaded",()=>{(document.getElementById("generate-short-description-btn")||document.getElementById("generate-long-description-btn"))&&new a});
